version: '3.4'

# This Compose file is expected to be used with the devnet-up.sh script.
# The volumes below mount the configs generated by the script into each
# service.

volumes:
  l1_data:
  l2_data:

services:
  l1:
    build:
      context: .
      dockerfile: Dockerfile.l1
    ports:
      - "8545:8545"
    volumes:
      - "l1_data:/db"
      - ${PWD}/../.devnet/genesis-l1.json:/genesis.json

  l2:
    build:
      context: .
      dockerfile: Dockerfile.l2
    ports:
      - "9545:8545"
    volumes:
      - "l2_data:/db"
      - ${PWD}/../.devnet/genesis-l2.json:/genesis.json

  opnode:
    depends_on:
      - l1
      - l2
    build:
      context: ../
      dockerfile: ./ops/Dockerfile.opnode
    command:
      - op
      - --l1=ws://l1:8546
      - --l2=ws://l2:8546
      - --sequencing.enabled
      - --rollup.config=/rollup.json
      - --batchsubmitter.key=/config/bss-key.txt
      - --l2.eth=http://l2:8545
      - --rpc.addr=0.0.0.0
      - --rpc.port=8545
    ports:
        - "7545:8545"
    volumes:
      - ${PWD}/bss-key.txt:/config/bss-key.txt
      - ${PWD}/../.devnet/rollup.json:/rollup.json

  l2os:
    depends_on:
      - l1
      - l2
      - opnode
    build:
      context: ../
      dockerfile: ./ops/Dockerfile.l2os
    environment:
      L1_ETH_RPC: http://l1:8545
      L2_ETH_RPC: http://l2:8545
      ROLLUP_RPC: http://opnode:8545
      OUTPUT_SUBMITTER_POLL_INTERVAL: 10s
      OUTPUT_SUBMITTER_NUM_CONFIRMATIONS: 1
      OUTPUT_SUBMITTER_SAFE_ABORT_NONCE_TOO_LOW_COUNT: 3
      OUTPUT_SUBMITTER_RESUBMISSION_TIMEOUT: 30s
      OUTPUT_SUBMITTER_MNEMONIC: test test test test test test test test test test test junk
      OUTPUT_SUBMITTER_L2_OUTPUT_HD_PATH: "m/44'/60'/0'/0/1"